"use client";

import { useState, useRef } from "react";
import { useQuery, useMutation } from "convex/react";
import { api } from "../../convex/_generated/api";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import {
  FileText,
  Upload,
  Trash2,
  Download,
  Eye,
  Loader2,
  File
} from "lucide-react";
import { motion, AnimatePresence } from "framer-motion";
import { Id } from "../../convex/_generated/dataModel";

type DocumentType = "resume" | "cover_letter" | "portfolio";

export function DocumentManagement() {
  const [activeDocType, setActiveDocType] = useState<DocumentType>("resume");
  const [isDragging, setIsDragging] = useState(false);
  const [isUploading, setIsUploading] = useState(false);
  const fileInputRef = useRef<HTMLInputElement>(null);

  const allDocuments = useQuery(api.documents.getUserDocuments);
  const documentsByType = useQuery(api.documents.getDocumentsByType, { fileType: activeDocType });
  const generateUploadUrl = useMutation(api.documents.generateUploadUrl);
  const createDocument = useMutation(api.documents.createDocument);
  const deleteDocument = useMutation(api.documents.deleteDocument);
  const getDocumentUrl = useQuery(api.documents.getDocumentUrl,
    documentsByType && documentsByType.length > 0 && documentsByType[0].storageId
      ? { storageId: documentsByType[0].storageId }
      : "skip"
  );

  const handleDragEnter = (e: React.DragEvent) => {
    e.preventDefault();
    e.stopPropagation();
    setIsDragging(true);
  };

  const handleDragLeave = (e: React.DragEvent) => {
    e.preventDefault();
    e.stopPropagation();
    setIsDragging(false);
  };

  const handleDragOver = (e: React.DragEvent) => {
    e.preventDefault();
    e.stopPropagation();
  };

  const handleDrop = async (e: React.DragEvent) => {
    e.preventDefault();
    e.stopPropagation();
    setIsDragging(false);

    const files = Array.from(e.dataTransfer.files);
    if (files.length > 0) {
      await handleFileUpload(files[0]);
    }
  };

  const handleFileSelect = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = e.target.files;
    if (files && files.length > 0) {
      await handleFileUpload(files[0]);
    }
  };

  const handleFileUpload = async (file: File) => {
    setIsUploading(true);
    try {
      // Step 1: Get a short-lived upload URL
      const uploadUrl = await generateUploadUrl();

      // Step 2: POST the file to the URL
      const result = await fetch(uploadUrl, {
        method: "POST",
        headers: { "Content-Type": file.type },
        body: file,
      });

      if (!result.ok) {
        throw new Error(`Upload failed: ${result.statusText}`);
      }

      const { storageId } = await result.json();

      // Step 3: Save the file metadata to the database
      await createDocument({
        storageId,
        fileName: file.name,
        fileSize: file.size,
        fileFormat: file.type || "application/octet-stream",
        fileType: activeDocType,
      });

      // Reset file input
      if (fileInputRef.current) {
        fileInputRef.current.value = "";
      }
    } catch (error) {
      console.error("Upload error:", error);
      alert("Failed to upload file. Please try again.");
    } finally {
      setIsUploading(false);
    }
  };

  const handleDelete = async (documentId: Id<"documents">) => {
    if (confirm("Are you sure you want to delete this document?")) {
      try {
        await deleteDocument({ documentId });
      } catch (error) {
        console.error("Delete error:", error);
        alert("Failed to delete document. Please try again.");
      }
    }
  };

  const handleDownload = async (storageId: string, fileName: string) => {
    // TODO: Implement download using Convex storage URL
    console.log("Download:", storageId, fileName);
  };

  const formatFileSize = (bytes: number) => {
    if (bytes < 1024) return bytes + " B";
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + " KB";
    return (bytes / (1024 * 1024)).toFixed(1) + " MB";
  };

  const getDocumentTypeName = (type: DocumentType) => {
    switch (type) {
      case "resume": return "Resume / CV";
      case "cover_letter": return "Cover Letter";
      case "portfolio": return "Portfolio";
    }
  };

  return (
    <Card className="bg-gradient-to-br from-white/[0.08] to-white/[0.04] backdrop-blur-sm border-white/10">
      <CardHeader>
        <CardTitle className="text-2xl text-white">Document Management</CardTitle>
        <CardDescription className="text-white/60">
          Upload and manage your job application documents
        </CardDescription>
      </CardHeader>
      <CardContent>
        {/* Document Type Tabs */}
        <Tabs value={activeDocType} onValueChange={(value) => setActiveDocType(value as DocumentType)}>
          <TabsList className="grid w-full grid-cols-3 bg-white/5 border border-white/10 mb-6">
            <TabsTrigger
              value="resume"
              className="data-[state=active]:bg-gradient-to-r data-[state=active]:from-indigo-500/20 data-[state=active]:to-purple-500/20 data-[state=active]:text-white"
            >
              Resume / CV
            </TabsTrigger>
            <TabsTrigger
              value="cover_letter"
              className="data-[state=active]:bg-gradient-to-r data-[state=active]:from-indigo-500/20 data-[state=active]:to-purple-500/20 data-[state=active]:text-white"
            >
              Cover Letter
            </TabsTrigger>
            <TabsTrigger
              value="portfolio"
              className="data-[state=active]:bg-gradient-to-r data-[state=active]:from-indigo-500/20 data-[state=active]:to-purple-500/20 data-[state=active]:text-white"
            >
              Portfolio
            </TabsTrigger>
          </TabsList>

          {/* Upload Area */}
          <div
            onDragEnter={handleDragEnter}
            onDragOver={handleDragOver}
            onDragLeave={handleDragLeave}
            onDrop={handleDrop}
            className={`relative mb-6 border-2 border-dashed rounded-lg p-8 transition-all ${
              isDragging
                ? "border-indigo-400 bg-indigo-500/10"
                : "border-white/20 bg-white/5"
            }`}
          >
            <input
              ref={fileInputRef}
              type="file"
              accept=".pdf,.doc,.docx,.txt"
              onChange={handleFileSelect}
              className="hidden"
            />

            {isUploading ? (
              <div className="flex flex-col items-center justify-center gap-3">
                <Loader2 className="h-12 w-12 text-indigo-400 animate-spin" />
                <p className="text-white/80 font-medium">Uploading...</p>
              </div>
            ) : (
              <div className="flex flex-col items-center justify-center gap-4">
                <div className="p-4 bg-gradient-to-br from-indigo-500/20 to-purple-500/20 rounded-full">
                  <Upload className="h-8 w-8 text-indigo-400" />
                </div>
                <div className="text-center">
                  <p className="text-white font-medium mb-1">
                    Drag and drop your {getDocumentTypeName(activeDocType).toLowerCase()} here
                  </p>
                  <p className="text-white/50 text-sm mb-4">
                    or click to browse files
                  </p>
                  <Button
                    onClick={() => fileInputRef.current?.click()}
                    className="bg-gradient-to-r from-indigo-500 to-purple-500 hover:from-indigo-600 hover:to-purple-600 text-white"
                  >
                    <Upload className="h-4 w-4 mr-2" />
                    Choose File
                  </Button>
                </div>
                <p className="text-white/40 text-xs">
                  Supported formats: PDF, DOC, DOCX, TXT
                </p>
              </div>
            )}
          </div>

          {/* Document List */}
          <div>
            <h3 className="text-lg font-semibold text-white mb-4">
              Your {getDocumentTypeName(activeDocType)}s
            </h3>

            {documentsByType === undefined ? (
              <div className="text-center py-8">
                <Loader2 className="h-8 w-8 text-indigo-400 animate-spin mx-auto" />
              </div>
            ) : documentsByType.length === 0 ? (
              <div className="text-center py-8 text-white/50">
                <File className="h-12 w-12 mx-auto mb-3 opacity-30" />
                <p>No {getDocumentTypeName(activeDocType).toLowerCase()}s uploaded yet</p>
              </div>
            ) : (
              <div className="space-y-3">
                <AnimatePresence>
                  {documentsByType.map((doc, index) => (
                    <motion.div
                      key={doc._id}
                      initial={{ opacity: 0, y: 20 }}
                      animate={{ opacity: 1, y: 0 }}
                      exit={{ opacity: 0, x: -100 }}
                      transition={{ duration: 0.3, delay: index * 0.05 }}
                      className="flex items-center justify-between p-4 bg-white/5 border border-white/10 rounded-lg hover:bg-white/10 transition-colors"
                    >
                      <div className="flex items-center gap-3 flex-1">
                        <div className="p-2 bg-gradient-to-br from-indigo-500/20 to-purple-500/20 rounded-lg">
                          <FileText className="h-5 w-5 text-indigo-400" />
                        </div>
                        <div className="flex-1 min-w-0">
                          <p className="text-white font-medium truncate">
                            {doc.fileName}
                          </p>
                          <p className="text-white/50 text-sm">
                            {formatFileSize(doc.fileSize)} â€¢ {new Date(doc.uploadedAt).toLocaleDateString()}
                          </p>
                        </div>
                      </div>

                      <div className="flex items-center gap-2">
                        <Button
                          size="sm"
                          variant="ghost"
                          onClick={() => handleDownload(doc.storageId, doc.fileName)}
                          className="text-white/70 hover:text-white hover:bg-white/10"
                        >
                          <Download className="h-4 w-4" />
                        </Button>
                        <Button
                          size="sm"
                          variant="ghost"
                          onClick={() => handleDelete(doc._id)}
                          className="text-rose-400/70 hover:text-rose-400 hover:bg-rose-500/10"
                        >
                          <Trash2 className="h-4 w-4" />
                        </Button>
                      </div>
                    </motion.div>
                  ))}
                </AnimatePresence>
              </div>
            )}
          </div>
        </Tabs>
      </CardContent>
    </Card>
  );
}
