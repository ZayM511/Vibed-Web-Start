<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Posting Age Parser Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-case {
      background: white;
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
      border-left: 4px solid #4CAF50;
    }
    .test-case.fail {
      border-left-color: #f44336;
    }
    .input {
      font-weight: bold;
      color: #1976D2;
    }
    .expected {
      color: #388E3C;
    }
    .actual {
      color: #D32F2F;
    }
    h1 {
      color: #333;
    }
    .summary {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-top: 30px;
      text-align: center;
    }
    .pass { color: #4CAF50; font-weight: bold; }
    .fail { color: #f44336; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Posting Age Parser Test Suite</h1>
  <div id="test-results"></div>
  <div class="summary" id="summary"></div>

  <script>
    // Copy the parsePostingAge function from popup-v2.js
    function parsePostingAge(dateString) {
      if (!dateString) {
        console.log('[Scanner Debug] parsePostingAge: No date string provided');
        return null;
      }

      const normalized = dateString.toLowerCase().trim();
      console.log('[Scanner Debug] parsePostingAge: Input:', dateString, '-> Normalized:', normalized);

      // Handle "just posted", "today", "just now", etc.
      if (/just\s*(?:posted|now)|moments?\s*ago|posted\s*today|\btoday\b/i.test(normalized)) {
        console.log('[Scanner Debug] parsePostingAge: Matched "just posted/today/just now" -> 0 days');
        return 0;
      }

      // Handle "yesterday" or "posted yesterday"
      if (/(?:posted\s+)?yesterday/i.test(normalized)) {
        console.log('[Scanner Debug] parsePostingAge: Matched "yesterday" -> 1 day');
        return 1;
      }

      let match;

      // CRITICAL FIX: Match Indeed's "EmployerActive X days ago" or "Active X days ago" format
      // This is the PRIMARY format used by Indeed on job listings
      if ((match = normalized.match(/(?:employer\s*)?active\s*(\d+)\s*days?\s*ago/i))) {
        const days = parseInt(match[1]);
        console.log('[Scanner Debug] parsePostingAge: Matched "Active/EmployerActive X days ago" ->', match[1], '-> Days:', days);
        return days;
      }

      // Match "X minutes ago" or "Posted X minutes ago"
      if ((match = normalized.match(/(?:posted\s+)?(\d+)\s*(?:minutes?|min|m)\s*ago/i))) {
        console.log('[Scanner Debug] parsePostingAge: Matched minutes ->', match[1], '-> 0 days');
        return 0;
      }

      // Match "X hours ago" or "Posted X hours ago"
      if ((match = normalized.match(/(?:posted\s+)?(\d+)\s*(?:hours?|hr|h)\s*ago/i))) {
        console.log('[Scanner Debug] parsePostingAge: Matched hours ->', match[1], '-> 0 days');
        return 0;
      }

      // Match "X days ago" or "Posted X days ago"
      if ((match = normalized.match(/(?:posted\s+)?(\d+)\s*(?:days?|d)\s*ago/i))) {
        const days = parseInt(match[1]);
        console.log('[Scanner Debug] parsePostingAge: Matched days ->', match[1], '-> Days:', days);
        return days;
      }

      // Match "X weeks ago" or "Posted X weeks ago"
      if ((match = normalized.match(/(?:posted\s+)?(\d+)\s*(?:weeks?|wk|w)\s*ago/i))) {
        const days = parseInt(match[1]) * 7;
        console.log('[Scanner Debug] parsePostingAge: Matched weeks ->', match[1], '-> Days:', days);
        return days;
      }

      // Match "X months ago" or "Posted X months ago"
      if ((match = normalized.match(/(?:posted\s+)?(\d+)\s*(?:months?|mo)\s*ago/i))) {
        const days = parseInt(match[1]) * 30;
        console.log('[Scanner Debug] parsePostingAge: Matched months ->', match[1], '-> Days:', days);
        return days;
      }

      // Match "30+ days ago" or "Posted 30+ days ago" (jobs older than 30 days)
      if ((match = normalized.match(/(?:posted\s+)?(\d+)\+\s*(?:days?|d)\s*ago/i))) {
        const days = parseInt(match[1]);
        console.log('[Scanner Debug] parsePostingAge: Matched "30+ days ago" ->', match[1], '-> Days:', days);
        return days;
      }

      console.log('[Scanner Debug] parsePostingAge: No pattern matched, returning null');
      console.warn('[Scanner Debug] ⚠️ Unrecognized date format:', dateString);
      return null;
    }

    // Test cases - includes all Indeed date formats
    const testCases = [
      // JSON-LD "Posted X days ago" format
      { input: 'Posted 180 days ago', expected: 180 },
      { input: 'Posted 6 months ago', expected: 180 },
      { input: 'Posted 225 days ago', expected: 225 },
      { input: 'Posted today', expected: 0 },
      { input: 'Posted 1 day ago', expected: 1 },
      { input: 'Posted 7 days ago', expected: 7 },
      { input: 'Posted 2 weeks ago', expected: 14 },
      { input: 'Posted 1 month ago', expected: 30 },
      { input: 'Posted yesterday', expected: 1 },
      { input: 'Posted 45 minutes ago', expected: 0 },

      // Indeed's "EmployerActive X days ago" format (CRITICAL)
      { input: 'EmployerActive 35 days ago', expected: 35 },
      { input: 'Active 45 days ago', expected: 45 },
      { input: 'EmployerActive 90 days ago', expected: 90 },
      { input: 'Active 120 days ago', expected: 120 },
      { input: 'Active 7 days ago', expected: 7 },

      // "30+ days ago" format
      { input: '30+ days ago', expected: 30 },
      { input: 'Posted 30+ days ago', expected: 30 },
      { input: '60+ days ago', expected: 60 },

      // Plain "X days ago" format (without "Posted")
      { input: '5 days ago', expected: 5 },
      { input: '3 weeks ago', expected: 21 },
      { input: '2 hours ago', expected: 0 },

      // Today/yesterday/just now
      { input: 'just now', expected: 0 },
      { input: 'today', expected: 0 },
      { input: 'yesterday', expected: 1 },
      { input: 'just posted', expected: 0 },

      // Edge cases
      { input: null, expected: null },
      { input: '', expected: null },
      { input: 'Active', expected: null },
      { input: 'Some random text', expected: null }
    ];

    // Run tests
    let passed = 0;
    let failed = 0;
    const resultsDiv = document.getElementById('test-results');

    testCases.forEach((test, index) => {
      const actual = parsePostingAge(test.input);
      const pass = actual === test.expected;

      if (pass) passed++;
      else failed++;

      const testDiv = document.createElement('div');
      testDiv.className = `test-case ${pass ? '' : 'fail'}`;
      testDiv.innerHTML = `
        <strong>Test ${index + 1}:</strong> ${pass ? '✓ PASS' : '✗ FAIL'}<br>
        <span class="input">Input:</span> "${test.input}"<br>
        <span class="expected">Expected:</span> ${test.expected} days<br>
        <span class="actual">Actual:</span> ${actual} days
      `;
      resultsDiv.appendChild(testDiv);
    });

    // Summary
    const summaryDiv = document.getElementById('summary');
    const totalTests = testCases.length;
    const passRate = ((passed / totalTests) * 100).toFixed(1);
    summaryDiv.innerHTML = `
      <h2>Test Summary</h2>
      <p>
        <span class="pass">${passed} PASSED</span> /
        <span class="fail">${failed} FAILED</span> /
        <strong>${totalTests} TOTAL</strong>
      </p>
      <p>Pass Rate: <strong>${passRate}%</strong></p>
    `;

    console.log('=== TEST SUMMARY ===');
    console.log(`PASSED: ${passed}/${totalTests}`);
    console.log(`FAILED: ${failed}/${totalTests}`);
    console.log(`PASS RATE: ${passRate}%`);
  </script>
</body>
</html>
